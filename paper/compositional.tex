\section{Compositionality of Ranking Supermartingales Revisited}
\label{sec:compositional}

Compositionality in the context of termination proving means providing the 
proof of termination step-by-step, handling one loop at a time, rather than 
attempting to construct the proof (in our case, a LexRSM) at once, by solving a 
single large system of constraints. In non-probabilistic setting, the 
relationship between lexicographic ranking functions and compositional 
termination proving is well established, as well as the importance of 
compositional proofs for efficient implementation~\cite{xxx}. In the context of 
probabilistic programs, the work~\cite{HolgerPOPL} attempted to provide a 
compositional notion of almost-sure termination proof based on the 
\emph{probabilistic variant rule (V-rule),} which we explain in a more detail 
below. 
However, as already noted in~\cite{HolgerPOPL}, the probabilistic V-rule is not 
sound in general. In order to rectify this issue, in~\cite{HolgerPOPL} they 
impose an additional constraint of \emph{uniform integrability} on ranking 
supermartingales that prove termination of individual loops, 
under which the probabilistic V-rule is shown to be sound. Apart from uniform 
integrability being somewhat restrictive in itself, in~\cite{HolgerPOPL} it is 
argued that proving uniform integrability is beyond the capability of 
state-of-the-art automated theorem provers. As a substitute for 
these,~\cite{HolgerPOPL} introduces a type system that can be used to 
automatically prove 
uniform integrability of ranking supermartingales for a restricted class of 
programs. In particular, the method cannot handle programs in which termination 
is controlled by variable that can be modified by a non-constant value, e.g. 
variable $x$ which appears in an assignment of the form $x:=x-y$. In this 
section we show that using our insights in lexicographic supermartingales we 
can obtain a subtly different notion of a probabilistic V-rule which is sound 
without any additional assumptions, and which can be used to prove termination 
of programs that the previous method cannot handle. 

Let $\program$ be a \PP{} of the form $\textbf{while } \Psi \textbf{ do } 
\programbody \textbf{ od}$. We denote by $\loops(\program)$ the set of all 
loops in $\program$ there are on the top level of $\programbody$, i.e. they are 
nested loops of $\program$ nested directly "below" the outer loop. We define an 
un-nested slice of $\program$ to be a \PP{} $\slice(\program)$ obtained from 
$\program$ by removing all loops in $\loops(\program)$ and replacing them with 
skip statements. We also define the set 
$\alloops(\program)$ of all loops in $\program$, i.e. 
$\alloops(\program):=\loops(\program)\cup \{\loops(\program')\mid \program'\in 
\loops(\program)\}$. The above definitions do not specify the initialization 
preamble for the sub-programs $\program'\in\alloops(\program)$: we can deem 
this pre-amble empty, i.e. consider these sub-programs with any initial 
valuation, or, provided that some invariant map $\inv$ for $\program$ is 
given, we can set the set of possible initial valuations of a sub-program 
$\program'$ to be the set $\inv(\loc^{\lin}_{\program'})$, where 
$\inv(\loc^{\lin}_{\program'})$ is the location of $\program$ corresponding to 
the head of the loop $\program'$.
A formal definition of 
both functions is given in \AppendixMaterial, we illustrate them in the 
following example.

\textbf{[PETR: INSERT EXAMPLE]}


Each measurable map for $\lem$ can be, in a natural way, restricted to a 
measurable map $\lem_{\program'}$ for $\program'\in \loops(\program)$, 
since each pCFG $\pCFG_{\program'}$ is a sub-pCFG of $\pCFG_{\program}$. 
Similarly, a measurable map $\lem$ for $\program$ can be restricted to a 
measurable map $\lem_{\slice}$ for $\slice(\program)$, since 
$\pCFG_{\slice(\program)}$ is produced from $\pCFG_{\program}$ essentially by 
removing certain locations (provided that we identify the locations forming 
heads of nested loops with locations preceding skip statements), and 
$\lem_{\slice}$ is defined to be equal to $\lem$ in all the locations that 
remained. Similarly, 

